# Google Learn Portal (クイズシステム V2)

Google Apps Script (GAS) を活用した、高機能なクイズ作成・分析・管理システムです。
Google スプレッドシートで問題を管理し、Google フォームを自動生成・更新できます。さらに、回答データを自動集計し、リッチなWeb分析ダッシュボードで成績や問題の質（良問・難問）を可視化します。

## 🚀 主な機能

### 1. Google フォーム自動生成 (`FormBuilder.gs`)
- **一括生成・更新**: `Master` シートのデータから、Google フォーム（問題、画像、選択肢、解説）を自動生成します。
- **リッチコンテンツ**: 解説画像や参考リンクを完了画面（フィードバック）に設定可能です。
- **完了画面カスタマイズ**: 回答後の画面に、分析ダッシュボードやポータルサイトへのリンクを自動埋め込みします。
- **入力制限**: ニックネーム入力に文字数制限（10文字以内）などのバリデーションを適用します。

### 2. 分析ダッシュボード (`WebApp.gs`, `index.html`)
- **モダンなUI**: Tailwind CSSを使用したレスポンシブなWebアプリとして動作します。
- **リアルタイム集計**: 平均点、合格率、受験者数をリアルタイムに表示します。
- **良問・難問分析**: 正答率や識別指数 (D.I.) に基づき、「難しかった問題」や「合否を分けた良問」を自動抽出して表示します。
- **ランキング機能**: 「掲載可」としたユーザーのみを対象とした成績ランキングを表示します。

### 3. 自動採点・集計エンジン (`DataAggregator.gs`)
- **自動採点**: フォーム回答時にトリガー実行され、即座に採点と集計を行います。
- **重複管理**: 同じニックネームで複数回回答があった場合、2回目以降は名前に日時を付与して別データとして管理します。
- **詳細分析**: 問題ごとの正答率計算や、合格・不合格者ごとの回答傾向分析を行います。

### 4. ポータル連携 (`HubConnector.gs`)
- **ディレクトリ登録**: 作成したクイズを、組織内の「ポータルサイト」（ディレクトリ管理用スプレッドシート）へワンクリックで登録・更新できます。
- **自動設定**: Configシートの設定値を読み取り、登録情報を自動補完します。

### 5. データインポート (`ImportData.gs`)
- **外部データ連携**: 特定形式の外部スプレッドシートから問題データをインポートし、本システム形式 (`Master` シート) に変換・取り込みを行う機能です。

## 🛠 セットアップ手順

### 1. スプレッドシートの準備
新規スプレッドシートを作成し、以下のシートを用意してください。

| シート名 | 用途 |
| --- | --- |
| **Master** | 問題データ入力用（A列:ID, B:問題文, C:画像URL, D-H:選択肢, I:正解番号, ...） |
| **Config** | システム設定用（Form_ID, Portal_Url 等を管理） |
| **Form Responses 1** | Google フォームの回答書き込み先（フォーム作成後に自動生成または紐付け） |
| **Analysis_Users** | （自動出力）ユーザーごとの分析結果書き出し先 |
| **Analysis_Questions** | （自動出力）問題ごとの分析結果書き出し先 |

※ `Config` シートは初回実行時に自動的に設定値が書き込まれます。

### 2. スクリプトのデプロイ
1. スクリプトエディタ右上の「デプロイ」>「新しいデプロイ」を選択。
2. 種類: 「ウェブアプリ」を選択。
3. 説明: 任意（例: Dashboard v1）
4. 次のユーザーとして実行: 「自分」
5. アクセスできるユーザー: 用途に合わせて設定（「全員」または「ドメイン内のユーザー」）。
6. 発行された **ウェブアプリURL** をコピーし、`Config` シートの `Dashboard_Url` というキー（A列）に対してB列に貼り付けます。

### 3. 初回実行とメニュー操作
スプレッドシートをリロードすると、メニューバーに **「⚡️クイズシステムV2」** が表示されます。

1. **初期化**: `Master` シートに問題データを入力します。
2. **フォーム生成**: **「フォーム生成・更新 (実行)」** をクリックします。
   - フォームが自動生成され、リンクが表示されます。
   - 同時に `Config` シートにフォームID等が保存されます。
3. **トリガー設定**: **「🛠 初期設定 (トリガー登録)」** を実行します。
   - これにより、フォーム回答時に自動で集計スクリプトが走るようになります。

## 📝 使い方

### 問題の追加・更新
1. `Master` シートの問題データを修正・追加します。
2. メニューから **「フォーム生成・更新 (実行)」** を再実行すると、フォームの内容が同期されます（既存の質問も更新されます）。

### 集計と分析
- **自動集計**: ユーザーが回答すると自動的に集計され、`Analysis_Users` シート等が更新されます。
- **手動更新**: メニューの **「🔄 集計データを更新」** で、過去の全データを含めて再集計できます（ダミーデータ生成後などに使用）。
- **ダッシュボード**: デプロイしたウェブアプリURLにアクセスすると、グラフィカルな分析結果を閲覧できます。

### ポータル登録
- メニューの **「🌐 ポータルへ登録」** を実行すると、設定されたHubスプレッドシートへこのクイズの情報を登録できます。

## 📂 ファイル構成

- **WebApp.gs**: 分析ダッシュボードのバックエンド (doGet, データ整形)。
- **index.html**: 分析ダッシュボードのフロントエンド (Tailwind CSS使用)。
- **FormBuilder.gs**: Google フォーム生成・更新、完了画面設定、トリガー設定ロジック。
- **DataAggregator.gs**: 回答データの採点・集計、重複ユーザー処理、統計計算。
- **HubConnector.gs**: 外部ポータルサイトへのディレクトリ登録機能。
- **ImportData.gs**: 外部スプレッドシートからの問題データインポート機能。
- **Utilities.gs**: 共通関数群 (設定取得、画像処理、Base64変換など)。
- **DummyDataGenerator.gs**: テスト用のダミー回答データ生成ツール。

## ⚠️ 注意事項
- **画像の使用**: Google Drive上の画像を使用する場合、ファイルの共有設定で「リンクを知っている全員」が閲覧可能になっている必要があります。
- **実行時間制限**: GASの仕様上、6分を超える処理はタイムアウトします。大量の問題生成時は適宜処理が分割されます。
